import asyncio
import time
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from datetime import datetime, timedelta

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
API_TOKEN = '–¢–í–û–ô_–¢–û–ö–ï–ù_–ó–î–ï–°–¨'
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ –ø–∞–º—è—Ç–∏)
users = {} 

# –°–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω
CARS_DATABASE = {
    "Toyota Camry": "Common",
    "Nissan Skyline GTR": "Rare",
    "BMW M5": "Epic",
    "Bugatti Chiron": "Legendary"
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REP
REP_REWARDS = {
    "Common": {"new": 20, "old": 4},
    "Rare": {"new": 100, "old": 20},
    "Epic": {"new": 500, "old": 100},
    "Legendary": {"new": 2500, "old": 500}
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –†–∞–Ω–≥–æ–≤
RANKS = [
    (0, "–õ—é–±–∏—Ç–µ–ª—å"),
    (1500, "–ü–æ–∏—Å–∫–æ–≤–∏–∫"),
    (5000, "–û—Ö–æ—Ç–Ω–∏–∫ –∑–∞ —Ä–µ–¥–∫–æ—Å—Ç—è–º–∏"),
    (15000, "–≠–∫—Å–ø–µ—Ä—Ç –º–∞—Ä–∫–∏"),
    (40000, "–≠—Å—Ç–µ—Ç"),
    (100000, "–ú–∏–ª–ª–∏–∞—Ä–¥–µ—Ä"),
    (250000, "–ò–∫–æ–Ω–∞ —Å—Ç–∏–ª—è")
]

def get_rank(rep):
    for threshold, name in reversed(RANKS):
        if rep >= threshold:
            return name
    return "–ù–æ–≤–∏—á–æ–∫"

def get_next_rank_info(rep):
    for i in range(len(RANKS)-1):
        if rep < RANKS[i+1][0]:
            next_rank_name = RANKS[i+1][1]
            next_rank_rep = RANKS[i+1][0]
            current_rank_rep = RANKS[i][0]
            progress = int((rep - current_rank_rep) / (next_rank_rep - current_rank_rep) * 100)
            return next_rank_name, progress
    return "MAX", 100

# --- –ö–û–ú–ê–ù–î–´ ---

@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer("üèé –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CarCase! –ò—Å–ø–æ–ª—å–∑—É–π /case —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å —Ä–∞–∑ –≤ 5 —á–∞—Å–æ–≤.")

@dp.message(Command("case"))
async def open_case(message: types.Message):
    user_id = message.from_user.id
    now = time.time()

    if user_id not in users:
        users[user_id] = {"rep": 0, "garage": [], "last_case": 0}

    wait_time = 18000
    if now - users[user_id]["last_case"] < wait_time:
        remaining = int(wait_time - (now - users[user_id]["last_case"]))
        hours = remaining // 3600
        minutes = (remaining % 3600) // 60
        await message.answer(f"‚è≥ –†–∞–Ω–æ! –°–ª–µ–¥—É—é—â–∏–π –∫–µ–π—Å —á–µ—Ä–µ–∑ {hours}—á {minutes}–º.")
        return

    import random
    car_name = random.choice(list(CARS_DATABASE.keys()))
    rarity = CARS_DATABASE[car_name]
    
    is_new = car_name not in users[user_id]["garage"]
    rep_gain = REP_REWARDS[rarity]["new" if is_new else "old"]
    
    users[user_id]["rep"] += rep_gain
    if is_new:
        users[user_id]["garage"].append(car_name)
    users[user_id]["last_case"] = now

    current_rank = get_rank(users[user_id]["rep"])
    next_rank, progress = get_next_rank_info(users[user_id]["rep"])
    
    bars = progress // 10
    progress_bar = "‚ñà" * bars + "‚ñë" * (10 - bars)

    msg = (
        f"üì¶ *–ö–ï–ô–° –û–¢–ö–†–´–¢!*\n\n"
        f"üë§ *–ò–≥—Ä–æ–∫:* @{message.from_user.username}\n"
        f"üèé *–ú–∞—à–∏–Ω–∞:* {car_name}\n"
        f"üíé *–†–µ–¥–∫–æ—Å—Ç—å:* {rarity}\n\n"
        f"üéñ *–í–∞—à —Å—Ç–∞—Ç—É—Å:* {current_rank}\n"
        f"üìä *–î–æ —Ä–∞–Ω–≥–∞ {next_rank}:*\n"
        f"`[{progress_bar}] {progress}%`\n\n"
        f"üìà *–†–µ–ø—É—Ç–∞—Ü–∏—è:* +{rep_gain} REP {'(–ù–û–í–ò–ù–ö–ê! üî•)' if is_new else '(–ü–æ–≤—Ç–æ—Ä)'}"
    )

    await message.answer(msg, parse_mode="Markdown")

@dp.message(Command("profile"))
async def profile(message: types.Message):
    user_id = message.from_user.id
    if user_id not in users:
        await message.answer("–¢—ã –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª –∫–µ–π—Å—ã!")
        return
    
    u = users[user_id]
    msg = (
        f"ü™™ *–ü–†–û–§–ò–õ–¨ –ö–û–õ–õ–ï–ö–¶–ò–û–ù–ï–†–ê*\n\n"
        f"üéñ *–°—Ç–∞—Ç—É—Å:* {get_rank(u['rep'])}\n"
        f"üèÜ *–û–±—â–∏–π REP:* {u['rep']}\n"
        f"üèé *–í –≥–∞—Ä–∞–∂–µ:* {len(u['garage'])} —à—Ç."
    )
    await message.answer(msg, parse_mode="Markdown")

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
